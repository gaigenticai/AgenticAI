<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Platform - Ingestion Testing UI</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e1e8ed;
            border-radius: 5px;
            background: #fafbfc;
        }

        .section h2 {
            color: #34495e;
            margin-top: 0;
        }

        .form-group {
            margin: 15px 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="file"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            max-width: 400px;
        }

        select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }

        button {
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .success {
            background-color: #27ae60;
        }

        .success:hover {
            background-color: #229954;
        }

        .danger {
            background-color: #e74c3c;
        }

        .danger:hover {
            background-color: #c0392b;
        }

        .result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }

        .result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .result.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .job-list {
            margin: 20px 0;
        }

        .job-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
            background: white;
        }

        .job-item h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }

        .job-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-pending { background: #f39c12; color: white; }
        .status-processing { background: #3498db; color: white; }
        .status-completed { background: #27ae60; color: white; }
        .status-failed { background: #e74c3c; color: white; }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }

        .metric-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Agentic Platform - Ingestion Testing UI</h1>

        <div class="section">
            <h2>üìä Service Health & Metrics</h2>
            <button onclick="checkHealth()">Check Service Health</button>
            <button onclick="loadMetrics()">Load Metrics</button>

            <div id="healthResult" class="result"></div>
            <div id="metricsResult" class="result"></div>
            <div id="metricsGrid" class="metrics-grid" style="display: none;"></div>
        </div>

        <div class="section">
            <h2>üì§ File Upload & Ingestion</h2>
            <div class="form-group">
                <label for="fileInput">Select CSV File:</label>
                <input type="file" id="fileInput" accept=".csv">
            </div>

            <div class="form-group">
                <label for="sourceType">Source Type:</label>
                <select id="sourceType">
                    <option value="csv">CSV</option>
                    <option value="excel">Excel</option>
                    <option value="json">JSON</option>
                </select>
            </div>

            <button onclick="uploadFile()" id="uploadBtn">Upload & Process File</button>
            <span id="uploadSpinner" class="loading hidden"></span>

            <div id="uploadResult" class="result"></div>
        </div>

        <div class="section">
            <h2>üìã Ingestion Jobs</h2>
            <button onclick="loadJobs()">Refresh Jobs List</button>
            <button onclick="clearCompletedJobs()" class="danger">Clear Completed Jobs</button>

            <div id="jobsResult" class="result"></div>
            <div id="jobsList" class="job-list"></div>
        </div>

        <div class="section">
            <h2>üîß API Testing</h2>
            <button onclick="testCreateJob()">Test Create Job API</button>
            <button onclick="testGetJob()">Test Get Job API</button>
            <button onclick="testListJobs()">Test List Jobs API</button>

            <div id="apiTestResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';

        // Utility functions
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 10000);
        }

        function showLoading(buttonId, spinnerId, loading = true) {
            const button = document.getElementById(buttonId);
            const spinner = document.getElementById(spinnerId);

            if (loading) {
                button.disabled = true;
                spinner.classList.remove('hidden');
            } else {
                button.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        // Health check function
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();

                if (response.ok) {
                    showResult('healthResult',
                        `‚úÖ Service is healthy!\nStatus: ${data.status}\nService: ${data.service}\nVersion: ${data.version}`,
                        'success'
                    );
                } else {
                    showResult('healthResult', `‚ùå Health check failed: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('healthResult', `‚ùå Health check error: ${error.message}`, 'error');
            }
        }

        // Load metrics function
        async function loadMetrics() {
            try {
                const response = await fetch(`${API_BASE}/metrics`);
                const text = await response.text();

                if (response.ok) {
                    showResult('metricsResult', '‚úÖ Metrics loaded successfully!', 'success');

                    // Parse and display key metrics
                    const metrics = parseMetrics(text);
                    displayMetrics(metrics);
                } else {
                    showResult('metricsResult', `‚ùå Failed to load metrics: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('metricsResult', `‚ùå Metrics error: ${error.message}`, 'error');
            }
        }

        function parseMetrics(text) {
            const lines = text.split('\n');
            const metrics = {};

            lines.forEach(line => {
                if (line.startsWith('# HELP')) {
                    const parts = line.split(' ');
                    if (parts.length >= 4) {
                        const name = parts[2];
                        const help = parts.slice(3).join(' ');
                        metrics[name] = { help, value: 0 };
                    }
                } else if (!line.startsWith('#') && line.trim()) {
                    const parts = line.split(' ');
                    if (parts.length >= 2) {
                        const name = parts[0].split('{')[0]; // Remove labels
                        const value = parseFloat(parts[1]);
                        if (metrics[name]) {
                            metrics[name].value = value;
                        }
                    }
                }
            });

            return metrics;
        }

        function displayMetrics(metrics) {
            const grid = document.getElementById('metricsGrid');
            const relevantMetrics = [
                'ingestion_jobs_total',
                'ingestion_records_processed_total',
                'active_ingestion_jobs'
            ];

            let html = '';
            relevantMetrics.forEach(key => {
                if (metrics[key]) {
                    html += `
                        <div class="metric-card">
                            <div class="metric-value">${metrics[key].value}</div>
                            <div class="metric-label">${key.replace(/_/g, ' ')}</div>
                        </div>
                    `;
                }
            });

            grid.innerHTML = html;
            grid.style.display = 'grid';
        }

        // File upload function
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const sourceType = document.getElementById('sourceType').value;

            if (!fileInput.files[0]) {
                showResult('uploadResult', '‚ùå Please select a file first', 'error');
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('source_type', sourceType);

            showLoading('uploadBtn', 'uploadSpinner', true);

            try {
                const response = await fetch(`${API_BASE}/ingestion/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    showResult('uploadResult',
                        `‚úÖ File uploaded successfully!\nJob ID: ${data.job_id}\nStatus: ${data.status}`,
                        'success'
                    );

                    // Refresh jobs list
                    setTimeout(() => loadJobs(), 1000);
                } else {
                    showResult('uploadResult', `‚ùå Upload failed: ${data.detail || response.status}`, 'error');
                }
            } catch (error) {
                showResult('uploadResult', `‚ùå Upload error: ${error.message}`, 'error');
            } finally {
                showLoading('uploadBtn', 'uploadSpinner', false);
            }
        }

        // Load jobs function
        async function loadJobs() {
            try {
                const response = await fetch(`${API_BASE}/ingestion/jobs?limit=10`);
                const jobs = await response.json();

                if (response.ok) {
                    displayJobs(jobs);
                    showResult('jobsResult', `‚úÖ Loaded ${jobs.length} jobs`, 'success');
                } else {
                    showResult('jobsResult', `‚ùå Failed to load jobs: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('jobsResult', `‚ùå Jobs error: ${error.message}`, 'error');
            }
        }

        function displayJobs(jobs) {
            const container = document.getElementById('jobsList');

            if (jobs.length === 0) {
                container.innerHTML = '<p>No jobs found.</p>';
                return;
            }

            let html = '';
            jobs.forEach(job => {
                const statusClass = `status-${job.status}`;
                const progressPercent = job.progress || 0;

                html += `
                    <div class="job-item">
                        <h3>${job.job_id}</h3>
                        <div class="job-meta">
                            <span>Status: <span class="status-badge ${statusClass}">${job.status}</span></span>
                            <span>Records: ${job.processed_records || 0}/${job.total_records || '?'}</span>
                            <span>Progress: ${progressPercent.toFixed(1)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                        ${job.start_time ? `<small>Started: ${new Date(job.start_time).toLocaleString()}</small>` : ''}
                        ${job.end_time ? `<small>Ended: ${new Date(job.end_time).toLocaleString()}</small>` : ''}
                        ${job.duration ? `<small>Duration: ${job.duration}</small>` : ''}
                        ${job.error_message ? `<div style="color: red; margin-top: 10px;">Error: ${job.error_message}</div>` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function clearCompletedJobs() {
            // This would need a backend endpoint to implement
            showResult('jobsResult', '‚ö† Clear completed jobs feature not implemented yet', 'info');
        }

        // API testing functions
        async function testCreateJob() {
            const testConfig = {
                source_config: {
                    source_name: "test_api_source",
                    source_type: "api",
                    connection_config: {
                        url: "https://jsonplaceholder.typicode.com/posts",
                        method: "GET"
                    }
                },
                priority: 1
            };

            try {
                const response = await fetch(`${API_BASE}/ingestion/jobs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testConfig)
                });

                const data = await response.json();

                if (response.ok) {
                    showResult('apiTestResult',
                        `‚úÖ Create Job API test passed!\nJob ID: ${data.job_id}`,
                        'success'
                    );
                } else {
                    showResult('apiTestResult', `‚ùå Create Job API test failed: ${data.detail}`, 'error');
                }
            } catch (error) {
                showResult('apiTestResult', `‚ùå Create Job API test error: ${error.message}`, 'error');
            }
        }

        async function testGetJob() {
            // Use a sample job ID - in real implementation, get from jobs list
            const sampleJobId = 'sample-job-id';

            try {
                const response = await fetch(`${API_BASE}/ingestion/jobs/${sampleJobId}`);

                if (response.status === 404) {
                    showResult('apiTestResult', '‚úÖ Get Job API test passed (expected 404 for sample ID)', 'success');
                } else if (response.ok) {
                    const data = await response.json();
                    showResult('apiTestResult',
                        `‚úÖ Get Job API test passed!\nJob: ${data.job_id}, Status: ${data.status}`,
                        'success'
                    );
                } else {
                    showResult('apiTestResult', `‚ùå Get Job API test failed: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('apiTestResult', `‚ùå Get Job API test error: ${error.message}`, 'error');
            }
        }

        async function testListJobs() {
            try {
                const response = await fetch(`${API_BASE}/ingestion/jobs?limit=5`);
                const data = await response.json();

                if (response.ok) {
                    showResult('apiTestResult',
                        `‚úÖ List Jobs API test passed!\nFound ${data.length} jobs`,
                        'success'
                    );
                } else {
                    showResult('apiTestResult', `‚ùå List Jobs API test failed: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('apiTestResult', `‚ùå List Jobs API test error: ${error.message}`, 'error');
                }
        }

        // Auto-load data on page load
        window.onload = function() {
            checkHealth();
            setTimeout(() => loadJobs(), 1000);
        };

        // Auto-refresh jobs every 30 seconds
        setInterval(() => {
            if (document.getElementById('jobsList').children.length > 0) {
                loadJobs();
            }
        }, 30000);
    </script>
</body>
</html>
